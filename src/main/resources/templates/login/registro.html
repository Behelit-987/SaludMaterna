<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Registro - Salud Materna</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .registration-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .btn-custom {
            background-color: #4CAF50;
            color: white;
        }
        .conditional-field {
            display: none;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .error-validation {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        .is-invalid {
            border-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="registration-container">
        <form class="auth-form" th:action="@{/registro}" method="post" th:object="${usuaria}" id="registroForm">
            <h2>Registro - Salud Materna</h2>
            
            <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>
            <div th:if="${success}" class="alert alert-success" role="alert" th:text="${success}"></div>
            
            <h5 class="mb-3">Información Personal</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="nombres" class="form-label">Nombres *</label>
                        <input type="text" class="form-control" id="nombres" name="nombres" required>
                        <div class="error-validation" id="nombres-error"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="apellidos" class="form-label">Apellidos *</label>
                        <input type="text" class="form-control" id="apellidos" name="apellidos" required>
                        <div class="error-validation" id="apellidos-error"></div>
                    </div>
                </div>
            <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento *</label>
                        <input type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento" required>
                        <div class="error-validation" id="fechaNacimiento-error"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="domicilio" class="form-label">Domicilio: *</label>
                        <input type="text" class="form-control" id="domicilio" name="domicilio" required>
                        <div class="error-validation" id="domicilio-error"></div>
                    </div>
            </div>
            
           <div class="row mb-3">
                <div class="col-md-6">
                    <label for="curp" class="form-label">CURP: *</label>
                    <input type="text" class="form-control" id="curp" name="curp" 
                           pattern="[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[A-Z0-9]{2}" 
                           maxlength="18" 
                           title="La CURP debe tener exactamente 18 caracteres alfanuméricos" 
                           required>
                    <small class="form-text text-muted">Debe tener exactamente 18 caracteres</small>
                    <div class="error-validation" id="curp-error"></div>
                </div>
                <div class="col-md-6">
                    <label for="numCelular" class="form-label">Celular: *</label>
                    <input type="tel" class="form-control" id="numCelular" name="numCelular" 
                           pattern="[0-9]{10}" 
                           maxlength="10" 
                           title="El número debe tener exactamente 10 dígitos" 
                           required>
                    <small class="form-text text-muted">10 dígitos sin espacios ni guiones</small>
                    <div class="error-validation" id="numCelular-error"></div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="numEmergencia" class="form-label">Número de Emergencia (Familiar o alguien de confianza): *</label>
                    <input type="tel" class="form-control" id="numEmergencia" name="numEmergencia" 
                           pattern="[0-9]{10}" 
                           maxlength="10" 
                           title="El número debe tener exactamente 10 dígitos" 
                           required>
                    <small class="form-text text-muted">10 dígitos sin espacios ni guiones</small>
                    <div class="error-validation" id="numEmergencia-error"></div>
                </div>
                
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="talla" class="form-label">Altura(metros): *</label>
                    <input type="number" class="form-control" id="talla" name="talla" 
                           step="0.01" 
                           min="0.5" 
                           max="2.5" 
                           title="La altura debe estar entre 0.5 y 2.5 metros" 
                           required>
                    <small class="form-text text-muted">Ejemplo: 1.75 (entre 0.5 y 2.5 metros)</small>
                    <div class="error-validation" id="talla-error"></div>
                </div>
                <div class="col-md-6">
                    <label for="peso" class="form-label">Peso(Kg) *</label>
                    <input type="number" class="form-control" id="peso" name="peso" step="0.01" min="30" max="200" required>
                    <small class="form-text text-muted">Ejemplo: 65.5 (entre 30 y 200 kg)</small>
                    <div class="error-validation" id="peso-error"></div>
                </div>
            </div>
            
            <h5 class="mb-3 mt-4">Cuenta a crear:</h5>
                <div class="mb-3">
                    <label for="email" class="form-label">Correo Electrónico *</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                    <div class="error-validation" id="email-error"></div>
                </div>
                <div class="mb-3">
				    <label for="passwordHash" class="form-label">Contraseña *</label>
				    <div class="input-group">
				        <input type="password" class="form-control" id="passwordHash" name="passwordHash" minlength="6" required>
				        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
				            <i class="bi bi-eye"></i> Mostrar
				        </button>
				    </div>
				    <small class="form-text text-muted">Mínimo 6 caracteres</small>
				    <div class="error-validation" id="passwordHash-error"></div>
				</div>


            
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-custom">Registrarse</button>
                <a th:href="@{/login}" class="btn btn-outline-secondary">¿Ya tienes cuenta? Inicia sesión</a>
            </div>
        </form>
    </div>
   </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registroForm');
            const curpInput = document.getElementById('curp');
            const numCelularInput = document.getElementById('numCelular');
            const numEmergenciaInput = document.getElementById('numEmergencia');
            const tallaInput = document.getElementById('talla');
            const pesoInput = document.getElementById('peso');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('passwordHash');
            
            // Función para mostrar errores
            function showError(inputId, message) {
                const errorElement = document.getElementById(inputId + '-error');
                const inputElement = document.getElementById(inputId);
                
                errorElement.textContent = message;
                inputElement.classList.add('is-invalid');
                
                // Remover el error después de 5 segundos
                setTimeout(() => {
                    errorElement.textContent = '';
                    inputElement.classList.remove('is-invalid');
                }, 5000);
            }
            
            // Función para limpiar errores
            function clearError(inputId) {
                const errorElement = document.getElementById(inputId + '-error');
                const inputElement = document.getElementById(inputId);
                
                errorElement.textContent = '';
                inputElement.classList.remove('is-invalid');
            }
            
            // Validación en tiempo real para CURP
            curpInput.addEventListener('input', function() {
                const curp = curpInput.value.trim().toUpperCase();
                curpInput.value = curp; // Convertir a mayúsculas
                
                if (curp.length === 0) {
                    clearError('curp');
                    return;
                }
                
                if (curp.length !== 18) {
                    showError('curp', 'La CURP debe tener exactamente 18 caracteres');
                    return;
                }
                
                const curpRegex = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[A-Z0-9]{2}$/;
                if (!curpRegex.test(curp)) {
                    showError('curp', 'Formato de CURP inválido');
                    return;
                }
                
                clearError('curp');
            });
            
            // Validación en tiempo real para teléfonos
            function validateTelefono(input, inputId, fieldName) {
                const value = input.value.trim();
                
                if (value.length === 0) {
                    clearError(inputId);
                    return;
                }
                
                const telefonoRegex = /^\d{10}$/;
                if (!telefonoRegex.test(value)) {
                    showError(inputId, `${fieldName} debe tener exactamente 10 dígitos`);
                    return;
                }
                
                clearError(inputId);
            }
            
            numCelularInput.addEventListener('input', function() {
                validateTelefono(numCelularInput, 'numCelular', 'El número celular');
            });
            
            numEmergenciaInput.addEventListener('input', function() {
                validateTelefono(numEmergenciaInput, 'numEmergencia', 'El número de emergencia');
            });
            
            // Validación en tiempo real para altura
            tallaInput.addEventListener('input', function() {
                const talla = parseFloat(tallaInput.value);
                
                if (isNaN(talla)) {
                    clearError('talla');
                    return;
                }
                
                if (talla < 0.5 || talla > 2.5) {
                    showError('talla', 'La altura debe estar entre 0.5 y 2.5 metros');
                    return;
                }
                
                clearError('talla');
            });
            
            // Validación en tiempo real para peso
            pesoInput.addEventListener('input', function() {
                const peso = parseFloat(pesoInput.value);
                
                if (isNaN(peso)) {
                    clearError('peso');
                    return;
                }
                
                if (peso < 30 || peso > 200) {
                    showError('peso', 'El peso debe estar entre 30 y 200 kg');
                    return;
                }
                
                clearError('peso');
            });
            
            // Validación en tiempo real para email
            emailInput.addEventListener('input', function() {
                const email = emailInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email.length === 0) {
                    clearError('email');
                    return;
                }
                
                if (!emailRegex.test(email)) {
                    showError('email', 'Ingresa un correo electrónico válido');
                    return;
                }
                
                clearError('email');
            });
            
            // Validación en tiempo real para contraseña
            passwordInput.addEventListener('input', function() {
                const password = passwordInput.value;
                
                if (password.length === 0) {
                    clearError('passwordHash');
                    return;
                }
                
                if (password.length < 6) {
                    showError('passwordHash', 'La contraseña debe tener al menos 6 caracteres');
                    return;
                }
                
                clearError('passwordHash');
            });
            
            // Validación al enviar el formulario
            form.addEventListener('submit', function(event) {
                let isValid = true;
                
                // Validar nombres
                const nombres = document.getElementById('nombres').value.trim();
                if (nombres.length === 0) {
                    showError('nombres', 'Los nombres son obligatorios');
                    isValid = false;
                }
                
                // Validar apellidos
                const apellidos = document.getElementById('apellidos').value.trim();
                if (apellidos.length === 0) {
                    showError('apellidos', 'Los apellidos son obligatorios');
                    isValid = false;
                }
                
                // Validar fecha de nacimiento
                const fechaNacimiento = document.getElementById('fechaNacimiento').value;
                if (!fechaNacimiento) {
                    showError('fechaNacimiento', 'La fecha de nacimiento es obligatoria');
                    isValid = false;
                } else {
                    // Validar que sea una fecha válida y que la persona sea mayor de 12 años
                    const fechaNac = new Date(fechaNacimiento);
                    const hoy = new Date();
                    const edad = hoy.getFullYear() - fechaNac.getFullYear();
                    const mes = hoy.getMonth() - fechaNac.getMonth();
                    
                    if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                        edad--;
                    }
                    
                    if (edad < 12) {
                        showError('fechaNacimiento', 'Debes tener al menos 12 años para registrarte');
                        isValid = false;
                    }
                }
                
                // Validar domicilio
                const domicilio = document.getElementById('domicilio').value.trim();
                if (domicilio.length === 0) {
                    showError('domicilio', 'El domicilio es obligatorio');
                    isValid = false;
                }
                
                // Validar CURP
                const curp = curpInput.value.trim().toUpperCase();
                if (curp.length !== 18) {
                    showError('curp', 'La CURP debe tener exactamente 18 caracteres');
                    isValid = false;
                } else {
                    const curpRegex = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[A-Z0-9]{2}$/;
                    if (!curpRegex.test(curp)) {
                        showError('curp', 'Formato de CURP inválido');
                        isValid = false;
                    }
                }
                
                // Validar teléfonos
                const telefonoRegex = /^\d{10}$/;
                
                const celular = numCelularInput.value.trim();
                if (!telefonoRegex.test(celular)) {
                    showError('numCelular', 'El número celular debe tener exactamente 10 dígitos');
                    isValid = false;
                }
                
                const emergencia = numEmergenciaInput.value.trim();
                if (!telefonoRegex.test(emergencia)) {
                    showError('numEmergencia', 'El número de emergencia debe tener exactamente 10 dígitos');
                    isValid = false;
                }
                
                // Validar que los números no sean iguales
                if (celular === emergencia) {
                    showError('numEmergencia', 'El número de emergencia no puede ser igual al celular');
                    isValid = false;
                }
                
                // Validar altura
                const talla = parseFloat(tallaInput.value);
                if (isNaN(talla) || talla < 0.5 || talla > 2.5) {
                    showError('talla', 'La altura debe estar entre 0.5 y 2.5 metros');
                    isValid = false;
                }
                
                // Validar peso
                const peso = parseFloat(pesoInput.value);
                if (isNaN(peso) || peso < 30 || peso > 200) {
                    showError('peso', 'El peso debe estar entre 30 y 200 kg');
                    isValid = false;
                }
                
                // Validar email
                const email = emailInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showError('email', 'Ingresa un correo electrónico válido');
                    isValid = false;
                }
                
                // Validar contraseña
                const password = passwordInput.value;
                if (password.length < 6) {
                    showError('passwordHash', 'La contraseña debe tener al menos 6 caracteres');
                    isValid = false;
                }
                
                // Si no es válido, prevenir el envío del formulario
                if (!isValid) {
                    event.preventDefault();
                    
                    // Desplazarse al primer error
                    const firstError = document.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('passwordHash');
            const eyeIcon = togglePassword.querySelector('i');
            
            togglePassword.addEventListener('click', function() {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.classList.remove('bi-eye');
                    eyeIcon.classList.add('bi-eye-slash');
                    togglePassword.innerHTML = '<i class="bi bi-eye-slash"></i> Ocultar';
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.classList.remove('bi-eye-slash');
                    eyeIcon.classList.add('bi-eye');
                    togglePassword.innerHTML = '<i class="bi bi-eye"></i> Mostrar';
                }
            });
        });

    </script>
</body>
</html>